---
import BaseLayout from '~/layouts/BaseLayout.astro';
import HeroCard from '~/components/HeroCard';
import { Fragment } from 'preact';
---

<BaseLayout
  title="Organisations directory"
  description="Organisations relevant to post-cardiac arrest research and service improvement"
>
  <Fragment slot="hero">
    <div class="relative left-1/2 w-screen -translate-x-1/2 px-4 sm:px-6 lg:px-8">
      <HeroCard
        eyebrow="RESEARCH"
        title={[{ text: 'Organisations directory', gradient: true }]}
        subtitle="Organisations relevant to post-cardiac arrest research and service improvement."
        variant="slate"
      />
    </div>
  </Fragment>

  <section class="-mt-12 -mx-4 px-4 pb-10 sm:-mx-6 sm:px-6 lg:-mx-8 lg:px-8">
    <div class="mx-auto max-w-6xl">
      <div class="rounded-3xl border border-slate-200 bg-white shadow-2xl ring-1 ring-slate-200/80">
        <div class="border-b border-slate-100 px-6 py-5">
          <p class="text-xs font-semibold uppercase tracking-wider text-slate-500">Note</p>
          <p class="mt-1 text-sm text-slate-600">
            Inclusion implies no endorsement. Information is for signposting only.
          </p>
        </div>

        <div class="grid gap-8 px-6 py-6 md:grid-cols-[260px_1fr]">
          {/* Sidebar */}
          <aside class="md:sticky md:top-6 md:max-h-[calc(100vh-4rem)] md:overflow-auto">
            <p class="text-xs font-semibold uppercase tracking-wider text-slate-500">
              Browse by country
            </p>
            <nav id="countryNav" class="mt-3 flex flex-col gap-2"></nav>

            <div class="mt-6 border-t border-slate-200 pt-4 text-sm">
              {/* swap these routes if you have them */}
              <a class="block text-slate-600 hover:text-slate-900" href="/contact">
                Suggest a resource
              </a>
              <a class="mt-2 block text-slate-600 hover:text-slate-900" href="/">
                Back to hub
              </a>
            </div>
          </aside>

          {/* Main */}
          <main class="min-w-0">
            <div class="relative">
              <svg
                class="pointer-events-none absolute left-3 top-1/2 h-5 w-5 -translate-y-1/2 text-slate-400"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path stroke-linecap="round" stroke-linejoin="round"
                  d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
              </svg>
              <input
                id="searchInput"
                class="w-full rounded-2xl border border-slate-200 bg-white py-3 pl-11 pr-10 text-base outline-none focus:border-indigo-300 focus:ring-4 focus:ring-indigo-100"
                placeholder="Search resources or organization names..."
                type="text"
              />
              <button
                id="searchClear"
                type="button"
                class="absolute right-2 top-1/2 hidden -translate-y-1/2 rounded-xl px-3 py-1 text-sm text-slate-500 hover:bg-slate-100"
              >
                ‚úï
              </button>
            </div>

            <div id="resultsContainer" class="mt-8 space-y-10"></div>
          </main>
        </div>
      </div>
    </div>
  </section>

  <script is:inline>
    // --- DATA ---
    const RESOURCES = [
      {
        country: { code: "GB", name: "United Kingdom" },
        name: "Resuscitation Council UK ‚Äî Survivor Support",
        link: "https://www.resus.org.uk/",
        description: "Directory-style page linking survivors and families to clinical guidelines and support options.",
        last_verified: "Dec 2025"
      },
      {
        country: { code: "IT", name: "Italy" },
        name: "Fondazione IRC ‚Äî Documenti",
        link: "https://www.fondazioneirc.org/",
        description: "Downloadable psychological support guides for those who have witnessed a cardiac arrest.",
        last_verified: "Dec 2025"
      }
    ];

    // --- LOGIC (same behaviour; no inline onclick) ---
    function getFlagImg(code, className) {
      if (!code || code.length !== 2) return "";
      const url = `https://flagcdn.com/w40/${code.toLowerCase()}.png`;
      return `<img src="${url}" class="${className}" alt="${code} flag" loading="lazy">`;
    }

    function groupByCountry(data) {
      const map = {};
      data.forEach(item => {
        const cName = item.country.name;
        if (!map[cName]) map[cName] = { ...item.country, items: [] };
        map[cName].items.push(item);
      });
      return Object.values(map).sort((a, b) => a.name.localeCompare(b.name));
    }

    const $nav = document.getElementById("countryNav");
    const $container = document.getElementById("resultsContainer");
    const $search = document.getElementById("searchInput");
    const $clearBtn = document.getElementById("searchClear");

    function renderCard(item) {
      return `
        <article class="rounded-2xl border border-slate-200 bg-white p-5 shadow-sm transition hover:-translate-y-0.5 hover:border-slate-300">
          <h3 class="text-base font-semibold text-slate-900">
            <a class="hover:text-indigo-700 hover:underline" href="${item.link}" target="_blank" rel="noopener">
              ${item.name}
            </a>
          </h3>
          <p class="mt-2 text-sm text-slate-600">${item.description}</p>
          <div class="mt-4 border-t border-dashed border-slate-200 pt-3 text-xs text-slate-500 text-right">
            Link verified: ${item.last_verified}
          </div>
        </article>
      `;
    }

    function scrollToGroup(code) {
      const el = document.getElementById(`group-${code}`);
      if (el) {
        const yOffset = -80;
        const y = el.getBoundingClientRect().top + window.pageYOffset + yOffset;
        window.scrollTo({ top: y, behavior: "smooth" });
      }
    }

    function resetSearch() {
      $search.value = "";
      render("");
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function render(filterText = "") {
      const term = (filterText || "").toLowerCase();
      $clearBtn.style.display = term.length > 0 ? "block" : "none";

      const allGroups = groupByCountry(RESOURCES);
      const totalUniqueCountries = allGroups.length;

      const filteredGroups = allGroups
        .map(group => {
          const matchingItems = group.items.filter(item => {
            const searchable = [item.name, item.description].join(" ").toLowerCase();
            return searchable.includes(term);
          });
          return { ...group, items: matchingItems };
        })
        .filter(g => g.items.length > 0);

      // Sidebar
      $nav.innerHTML =
        `<button type="button" class="country-btn ${term === "" ? "is-active" : ""}" data-action="reset">
          <span class="emoji">üåç</span>
          <span class="label">All Countries</span>
          <span class="badge">${totalUniqueCountries}</span>
        </button>` +
        filteredGroups
          .map(g => `
            <button type="button" class="country-btn" data-code="${g.code}">
              ${getFlagImg(g.code, "flag")}
              <span class="label">${g.name}</span>
              <span class="badge">${g.items.length}</span>
            </button>
          `)
          .join("");

      // Main
      if (filteredGroups.length === 0) {
        $container.innerHTML = `<div class="rounded-2xl bg-slate-50 p-10 text-center text-slate-500">
          No resources found matching "${filterText}"
        </div>`;
        return;
      }

      $container.innerHTML = filteredGroups
        .map(g => `
          <section id="group-${g.code}">
            <div class="mb-4 flex items-center gap-3 border-b-2 border-slate-200 pb-3">
              ${getFlagImg(g.code, "flag-lg")}
              <h2 class="text-xl font-semibold text-slate-900">${g.name}</h2>
            </div>
            <div class="grid gap-4 sm:grid-cols-2">
              ${g.items.map(renderCard).join("")}
            </div>
          </section>
        `)
        .join("");
    }

    // Event wiring (replaces inline onclick)
    $nav.addEventListener("click", (e) => {
      const btn = e.target.closest("button");
      if (!btn) return;
      if (btn.dataset.action === "reset") return resetSearch();
      if (btn.dataset.code) return scrollToGroup(btn.dataset.code);
    });

    $search.addEventListener("input", (e) => render(e.target.value));
    $clearBtn.addEventListener("click", resetSearch);

    // Init
    render("");

  </script>

  <style>
    /* Tiny local CSS for sidebar buttons, stays within this page */
    #countryNav .country-btn{
      display:flex; align-items:center; gap:.5rem;
      padding:.6rem .75rem;
      border:1px solid rgba(226,232,240,1);
      border-radius:1rem;
      background:#fff;
      color: rgba(51,65,85,1);
      font-size:.875rem;
      cursor:pointer;
    }
    #countryNav .country-btn:hover{ background: rgba(241,245,249,1); }
    #countryNav .country-btn.is-active{ border-color: rgba(199,210,254,1); background: rgba(238,242,255,1); color: rgba(67,56,202,1); }
    #countryNav .emoji{ width:1.25rem; text-align:center; }
    #countryNav .flag{ width:20px; height:15px; border-radius:4px; object-fit:cover; box-shadow:0 0 0 1px rgba(0,0,0,.08); }
    #countryNav .flag-lg{ width:28px; height:21px; border-radius:6px; object-fit:cover; box-shadow:0 0 0 1px rgba(0,0,0,.08); }
    #countryNav .label{ flex:1; text-align:left; }
    #countryNav .badge{
      padding:.1rem .5rem;
      border-radius:999px;
      background: rgba(226,232,240,1);
      color: rgba(51,65,85,1);
      font-size:.75rem;
      min-width: 2rem;
      text-align:center;
    }
    #countryNav .country-btn.is-active .badge{ background: rgba(219,234,254,1); color: rgba(37,99,235,1); }
  </style>
</BaseLayout>
